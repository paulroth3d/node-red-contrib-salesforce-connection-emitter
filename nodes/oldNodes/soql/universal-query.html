<script type="text/javascript">
	RED.nodes.registerType('universal-query',{
		category: 'Exploration Toolkit',
		color: '#C0DEED',
		defaults: {
			name: { value: '' },
			resultName: {required: true},
			api: { value: ''},
			query: { value: ''},
			usePayload: { value: false},
			limit: { value: 100, required: true, validate: RED.validators.number() },
		},
		inputs: 1,
		outputs: 1,
		icon: "db.png",
		label: function() {
			return this.name || "Run a SOQL query";
		},
		oneditprepare: function(){
			if (!this.api) {
				this.api = 'soap';
				$("#node-input-api").val(this.api);
			}

			this.editor = RED.editor.createEditor({
				id: 'node-input-query-editor',
				mode: 'ace/mode/html',
				value: $("#node-input-query").val()
			});
			RED.library.create({
					url:"functions", // where to get the data from
					type:"function", // the type of object the library is for
					editor:that.editor, // the field name the main text body goes to
					fields:['name','outputs']
			});
			this.editor.focus();
		},
		oneditsave: function(){
			console.log('oneditsave');
			$("#node-input-query").val(this.editor.getValue());
			console.log(`node-input-query: ${$('#node-input-query').val()}`);
			this.editor.destroy();
			delete this.editor;
		},
		oneditcancel: function(){
			console.log('oneditcancel');
			this.editor.destroy();
			delete this.editor;
		},
		oneditresize: function(size){
			console.log('oneditresize');
			var rows = $("#dialog-form>div:not(.node-text-editor-row)");
			var height = $("#dialog-form").height();
			for (var i=0; i<rows.size(); i++) {
					height -= $(rows[i]).outerHeight(true);
			}
			var editorRow = $("#dialog-form>div.node-text-editor-row");
			height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
			$(".node-text-editor").css("height",height+"px");
			this.editor.resize();
		}
	});
</script>

<script type="text/x-red" data-template-name="universal-query">
	<div class="form-row">
		<label for="node-input-name"><i class="icon-tag"></i> Name</label>
		<input type="text" id="node-input-name" placeholder="Name">
	</div>
	<div class="form-row">
		<label for="node-input-name"><i class="icon-tag"></i> Result Name</label>
		<input type="text" id="node-input-resultName">
	</div>

	<div class="form-row">
		<label for="node-input-api"><i class="fa fa-code"></i> Select Salesforce API</label>
		<select id="node-input-api" style="width:180px;">
			<option value="soap">Soap API</option>
			<option value="tooling">Tooling API</option>
		</select>
	</div>

	<div class="form-row">
		<label for="node-input-usePayload"><i class="icon-tag"></i> Use Payload</label>
		<input type="checkbox" id="node-input-usePayload">
	</div>

	<div class="form-row" style="margin-bottom: 0px;">
		<label for="node-input-query"><i class="fa fa-file-code-o"></i> Query</label>
		<input type="hidden" id="node-input-query" autofocus="autofocus">
	</div>

	<div class="form-row node-text-editor-row">
		<div style="height: 250px; min-height:150px;" 
			class="node-text-editor" 
			id="node-input-query-editor" ></div>
	</div>
	<div class="form-row">
			<label for="node-input-limit"><i class="icon-tag"></i> Limit</label>
			<input type="text" id="node-input-limit" placeholder="The query row limit.">
		</div>
</script>

<script type="text/x-red" data-help-name="universal-query">
	<p>Execute a SOQL query provided configuration or the msg.payload</p>
	<p>TIP: Use the template function to build up a dynamic query.</p>
</script>
